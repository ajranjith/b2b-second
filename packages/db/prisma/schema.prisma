generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  DEALER
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  OPS
}

enum DealerStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum Entitlement {
  GENUINE_ONLY
  AFTERMARKET_ONLY
  SHOW_ALL
}

enum PartType {
  GENUINE
  AFTERMARKET
  BRANDED
}

enum ImportType {
  PRODUCTS_GENUINE
  PRODUCTS_AFTERMARKET
  PRODUCTS_MIXED
  DEALERS
  BACKORDERS
  BACKORDER_UPDATE
  SUPERSESSION
  SPECIAL_PRICES
  FULFILLMENT_STATUS
}

enum ImportStatus {
  PROCESSING
  SUCCEEDED
  FAILED
  SUCCEEDED_WITH_ERRORS
}

enum NewsType {
  SPECIAL_PRICE_LIST
  NEW_TO_RANGE
  ACCESSORIES
  DISPATCH_UPDATE
  GENERAL
}

enum OrderStatus {
  SUSPENDED
  PROCESSING
  SHIPPED
  CANCELLED
}

enum ActorType {
  ADMIN
  DEALER
  SYSTEM
}

model AppUser {
  id           String     @id @default(uuid())
  email        String     @unique
  emailNormalized String? @unique
  passwordHash String
  role         UserRole
  adminRole    AdminRole?
  isActive     Boolean    @default(true)
  mustChangePassword Boolean @default(false)
  lastLoginAt  DateTime?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  dealerUser    DealerUser?
  importBatches ImportBatch[] @relation("ImportBatchesUploadedBy")
  auditLogs     AuditLog[]

  // Indexes for performance
  @@index([email])
  @@index([role, isActive])
}

model DealerAccount {
  id          String       @id @default(uuid())
  accountNo   String       @unique
  companyName String
  status      DealerStatus @default(ACTIVE)
  entitlement Entitlement  @default(SHOW_ALL)
  mainEmail   String?
  phone       String?
  contactFirstName String?
  contactLastName  String?

  billingLine1    String?
  billingLine2    String?
  billingCity     String?
  billingPostcode String?
  billingCountry  String?

  dispatchDefault String?

  defaultShippingMethod String?
  shippingNotes         String?
  notes                 String?

  // BUSINESS RULES (enforced at application level):
  // 1. Every DealerAccount MUST have at least one DealerUser (mandatory user association)
  // 3. User email must be unique system-wide (enforced via AppUser.email @unique)
  // 4. One user can only be associated with one dealer account (enforced via DealerUser.userId @unique)

  users           DealerUser[]
  discountTiers   DealerDiscountTier[]
  carts           Cart[]
  orders          OrderHeader[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Indexes for performance
  @@index([accountNo])
  @@index([status, entitlement])
  @@index([mainEmail])
}

model DealerUser {
  id              String   @id @default(uuid())
  dealerAccountId String
  userId          String   @unique
  isPrimary       Boolean  @default(false)
  firstName       String?
  lastName        String?
  createdAt       DateTime @default(now())

  dealerAccount DealerAccount @relation(fields: [dealerAccountId], references: [id], onDelete: Cascade)
  user          AppUser       @relation(fields: [userId], references: [id], onDelete: Cascade)

  cart   Cart?
  orders OrderHeader[]
}

model DealerDiscountTier {
  id              String   @id @default(uuid())
  dealerAccountId String
  discountCode    String
  tierCode        String
  updatedAt       DateTime @updatedAt

  dealerAccount DealerAccount @relation(fields: [dealerAccountId], references: [id], onDelete: Cascade)

  @@unique([dealerAccountId, discountCode])
  @@index([dealerAccountId, discountCode])
}

model Product {
  id           String   @id @default(uuid())
  productCode  String   @unique
  supplier     String?
  description  String
  discountCode String?
  partType     PartType
  isActive     Boolean  @default(true)

  stock      ProductStock?
  refPrice   ProductPriceReference?
  bandPrices ProductPriceBand[]
  netPrices  ProductNetPrice[]
  aliases    ProductAlias[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cartItems  CartItem[]
  orderLines OrderLine[]

  // Indexes for search performance
  @@index([productCode])
  @@index([partType, isActive])
  @@index([description])
}

model ProductNetPrice {
  id        String   @id @default(uuid())
  productId String
  tierCode  String
  price     Decimal  @db.Decimal(10, 2)
  updatedAt DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, tierCode])
  @@index([productId, tierCode])
}

model Supersession {
  id                  String   @id @default(uuid())
  originalPartCode    String
  replacementPartCode String
  note                String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([originalPartCode])
  @@unique([originalPartCode, replacementPartCode])
}

model ProductStock {
  productId         String   @id
  freeStock         Int      @default(0)
  lastImportBatchId String?
  updatedAt         DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model ProductPriceReference {
  productId         String   @id
  costPrice         Decimal?
  retailPrice       Decimal?
  tradePrice        Decimal?
  listPrice         Decimal?
  minimumPrice      Decimal?
  lastImportBatchId String?
  updatedAt         DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model ProductPriceBand {
  id        String   @id @default(uuid())
  productId String
  // Must be "1", "2", "3", "4" or "A"-"F"
  bandCode  String
  price     Decimal  @db.Decimal(10, 2)  // Max 99999999.99, 2 decimal places
  updatedAt DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Ensure one price per product per band
  @@unique([productId, bandCode])
  @@index([productId, bandCode])
}

model ProductAlias {
  id         String @id @default(uuid())
  productId  String
  aliasType  String
  aliasValue String

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([aliasType, aliasValue])
  @@index([aliasValue])
}

model ImportBatch {
  id          String       @id @default(uuid())
  importType  ImportType
  fileName    String
  fileHash    String
  filePath    String?
  status      ImportStatus @default(PROCESSING)
  startedAt   DateTime     @default(now())
  completedAt DateTime?
  totalRows   Int          @default(0)
  validRows   Int          @default(0)
  invalidRows Int          @default(0)
  rowCount    Int          @default(0)
  successCount Int         @default(0)
  errorCount  Int          @default(0)

  uploadedById String?
  uploadedBy   AppUser? @relation("ImportBatchesUploadedBy", fields: [uploadedById], references: [id])

  errors            ImportError[]
  stgProducts       StgProductPriceRow[]
  stgBackorders     StgBackorderRow[]
  stgDealerAccounts StgDealerAccountRow[]
  stgSupersessions  StgSupersessionRow[]
  stgSpecialPrices  StgSpecialPriceRow[]
  backorderDatasets BackorderDataset[]
  backorderUpdates  BackorderUpdateLine[]
}

model ImportError {
  id           String   @id @default(uuid())
  batchId      String
  rowNumber    Int
  columnName   String?
  errorCode    String?
  errorMessage String
  rawRowJson   Json?
  createdAt    DateTime @default(now())

  batch ImportBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)

  @@index([batchId])
}

model StgProductPriceRow {
  batchId      String
  rowNumber    Int
  partType     PartType
  supplier     String?
  productCode  String?
  description  String?
  discountCode String?

  costPrice   Decimal?
  retailPrice Decimal?
  tradePrice  Decimal?
  listPrice   Decimal?
  band1Price  Decimal?
  band2Price  Decimal?
  band3Price  Decimal?
  band4Price  Decimal?
  freeStock   Int?

  isValid          Boolean @default(false)
  validationErrors String?
  rawRowJson       Json?

  batch ImportBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)

  @@id([batchId, rowNumber])
  @@index([batchId, isValid])
}

model StgDealerAccountRow {
  batchId    String
  rowNumber  Int
  accountNo  String?
  companyName String?
  firstName  String?
  lastName   String?
  email      String?
  status     String?
  defaultShippingMethod String?
  shippingNotes String?

  genuineTier     String?
  aftermarketEsTier String?
  aftermarketBrTier String?

  isValid          Boolean @default(false)
  validationErrors String?
  rawRowJson       Json?

  batch ImportBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)

  @@id([batchId, rowNumber])
  @@index([batchId, isValid])
}

model StgSupersessionRow {
  batchId   String
  rowNumber Int
  originalPartCode String?
  replacementPartCode String?
  note      String?

  isValid          Boolean @default(false)
  validationErrors String?
  rawRowJson       Json?

  batch ImportBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)

  @@id([batchId, rowNumber])
  @@index([batchId, isValid])
}

model StgSpecialPriceRow {
  batchId   String
  rowNumber Int
  productCode String?
  discountCode String?
  description  String?
  discountPrice Decimal?

  isValid          Boolean @default(false)
  validationErrors String?
  rawRowJson       Json?

  batch ImportBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)

  @@id([batchId, rowNumber])
  @@index([batchId, isValid])
}

model StgBackorderRow {
  batchId   String
  rowNumber Int

  accountNo    String?
  customerName String?
  yourOrderNo  String?
  ourNo        String?
  itemNo       String?
  part         String?
  description  String?

  qtyOrdered     Int?
  qtyOutstanding Int?
  inWh           Int?

  isValid          Boolean @default(false)
  validationErrors String?
  rawRowJson       Json?

  batch ImportBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)

  @@id([batchId, rowNumber])
  @@index([batchId, isValid])
}

model BackorderDataset {
  id         String       @id @default(uuid())
  batchId    String
  status     ImportStatus
  isActive   Boolean      @default(false)
  uploadedAt DateTime     @default(now())

  batch ImportBatch     @relation(fields: [batchId], references: [id])
  lines BackorderLine[]

  @@index([isActive])
}

model BackorderLine {
  id        String @id @default(uuid())
  datasetId String
  sessionId String? @map("session_id") // Identity Framework: SID-A-* or SID-D-*

  accountNo    String
  customerName String?
  yourOrderNo  String?
  ourNo        String
  itemNo       String
  part         String
  description  String?

  qtyOrdered     Int @default(0)
  qtyOutstanding Int @default(0)
  inWh           Int @default(0)

  portalOrderNo String?

  dataset BackorderDataset @relation(fields: [datasetId], references: [id], onDelete: Cascade)

  @@index([accountNo])
  @@index([datasetId])
  @@index([sessionId])
}

model BackorderUpdateLine {
  id        String @id @default(uuid())
  batchId   String

  accountNo    String
  companyName  String?
  portalOrderNo String?
  ourOrderNo   String?
  totalItem    Int?
  productCode  String
  description  String?
  qtyOrdered   Int @default(0)
  qtyOutstanding Int @default(0)
  inWarehouse  Int @default(0)

  batch ImportBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)

  @@index([accountNo])
  @@index([batchId])
  @@unique([batchId, accountNo, productCode, portalOrderNo, ourOrderNo])
}

model Cart {
  id              String   @id @default(uuid())
  dealerAccountId String
  dealerUserId    String   @unique
  sessionId       String?  @map("session_id") // Identity Framework: SID-A-* or SID-D-*
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  dealerAccount DealerAccount @relation(fields: [dealerAccountId], references: [id])
  dealerUser    DealerUser    @relation(fields: [dealerUserId], references: [id], onDelete: Cascade)
  items         CartItem[]

  @@index([dealerAccountId])
  @@index([sessionId])
}

model CartItem {
  id        String @id @default(uuid())
  cartId    String
  productId String
  qty       Int

  cart    Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@unique([cartId, productId])
  @@index([cartId])
}

model OrderHeader {
  id              String      @id @default(uuid())
  orderNo         String      @unique
  portalOrderNumber String?   @unique
  dealerAccountId String
  dealerUserId    String
  status          OrderStatus @default(SUSPENDED)
  sessionId       String?     @map("session_id") // Identity Framework: SID-A-* or SID-D-*

  dispatchMethod String?
  shippingMethod String?
  poRef          String?
  poNumber       String?
  notes          String?
  orderNote      String?
  firstNameSnapshot String?
  lastNameSnapshot  String?
  emailSnapshot     String?
  accountNoSnapshot String?

  subtotal Decimal @default(0)
  total    Decimal @default(0)
  currency String  @default("GBP")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  dealerAccount DealerAccount @relation(fields: [dealerAccountId], references: [id])
  dealerUser    DealerUser    @relation(fields: [dealerUserId], references: [id])
  lines         OrderLine[]
  exportLines   OrderExportLine[]

  @@index([dealerAccountId, createdAt])
  @@index([dealerUserId])
  @@index([sessionId])
  @@index([status, createdAt])
}

model OrderLine {
  id        String @id @default(uuid())
  orderId   String
  productId String

  productCodeSnapshot String
  descriptionSnapshot String
  partTypeSnapshot    PartType

  qty               Int
  unitPriceSnapshot Decimal
  bandCodeSnapshot  String
  minPriceApplied   Boolean @default(false)
  lineTotalSnapshot Decimal?
  productCode       String?
  description       String?
  quantityOrdered   Int?

  // optional fulfillment fields for future
  lineStatus         String?
  shippedQty         Int       @default(0)
  backorderedQty     Int       @default(0)
  trackingNo         String?
  etaDate            DateTime?
  lastStatusUpdateAt DateTime?

  order   OrderHeader @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product     @relation(fields: [productId], references: [id])

  @@index([orderId])
}

model DealerPriceTierAssignment {
  id            String   @id @default(uuid())
  accountNo     String
  categoryCode  String
  netTier       String
  updatedAt     DateTime @updatedAt

  @@unique([accountNo, categoryCode])
  @@index([accountNo, categoryCode])
}

model ProductCatalog {
  productCode     String  @id
  fullDescription String
  freeStock       Int     @default(0)
  net1Price       Decimal @db.Decimal(10, 2)
  net2Price       Decimal @db.Decimal(10, 2)
  net3Price       Decimal @db.Decimal(10, 2)
  net4Price       Decimal @db.Decimal(10, 2)
  net5Price       Decimal @db.Decimal(10, 2)
  net6Price       Decimal @db.Decimal(10, 2)
  net7Price       Decimal @db.Decimal(10, 2)
  discountCode    String
  updatedAt       DateTime @updatedAt
  sourceBatchId   String?

  @@index([discountCode])
}

model SupersessionMap {
  id            String @id @default(uuid())
  fromPartNo    String
  toPartNo      String
  sourceBatchId String?

  @@index([fromPartNo])
}

model SupersessionResolved {
  id            String   @id @default(uuid())
  originalPartNo String
  latestPartNo   String
  depth          Int
  resolvedAt     DateTime @default(now())
  sourceBatchId  String?

  @@index([originalPartNo])
}

model OrderExportLine {
  id             String @id @default(uuid())
  orderId        String
  accountNo      String
  companyName    String?
  portalOrderNo  String
  totalItem      Int
  productCode    String
  description    String
  qtyOrdered     Int

  order OrderHeader @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
}

model SpecialPrice {
  id              String   @id @default(uuid())
  productCode     String
  discountCode    String
  description     String?
  discountPrice   Decimal  @db.Decimal(10, 2)
  currency        String   @default("GBP")
  startsAt        DateTime
  endsAt          DateTime
  isActive        Boolean  @default(true)
  dealerAccountId String?
  importBatchId   String?
  newsArticleId   String?
  source          String   @default("IMPORT")
  sourceBatchId   String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([productCode, discountCode, startsAt, endsAt, dealerAccountId])
  @@index([productCode])
  @@index([discountCode])
  @@index([dealerAccountId])
  @@index([startsAt, endsAt])
  @@index([newsArticleId])
  @@index([source])
}

model CartHeader {
  id            String   @id @default(uuid())
  accountNo     String
  expiresAt     DateTime
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  items CartItemContract[]

  @@index([accountNo])
}

model CartItemContract {
  id          String @id @default(uuid())
  cartId      String
  productCode String
  quantity    Int

  cart CartHeader @relation(fields: [cartId], references: [id], onDelete: Cascade)

  @@index([cartId])
}

model BackorderLineContract {
  id             String   @id @default(uuid())
  accountNo       String
  portalOrderNumber String?
  erpOrderNumber  String?
  productCode     String
  description     String?
  qtyOrdered      Int @default(0)
  qtyOutstanding  Int @default(0)
  inWarehouse     Int @default(0)
  updatedAt       DateTime @updatedAt

  @@index([accountNo])
}

model NewsArticle {
  id          String   @id @default(uuid())
  type        NewsType @default(GENERAL)
  title       String
  bodyMd      String
  isPublished Boolean  @default(false)
  publishedAt DateTime?
  startsAt    DateTime?
  endsAt      DateTime?
  isArchived  Boolean  @default(false)
  archivedAt  DateTime?
  sessionId   String?  @map("session_id") // Identity Framework: SID-A-* or SID-D-*
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  attachments NewsAttachment[]

  @@index([sessionId])
}

model NewsAttachment {
  id          String   @id @default(uuid())
  articleId   String
  fileName    String
  blobPath    String
  mimeType    String
  sizeBytes   BigInt   @default(0)
  uploadedAt  DateTime @default(now())

  article NewsArticle @relation(fields: [articleId], references: [id], onDelete: Cascade)
}

model SupportRequest {
  id         String   @id @default(uuid())
  accountNo  String?
  email      String
  subject    String
  message    String
  status     String   @default("OPEN")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model PasswordResetToken {
  id         String   @id @default(uuid())
  userId     String
  tokenHash  String
  expiresAt  DateTime
  usedAt     DateTime?
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
}

model SystemSetting {
  key       String   @id
  valueJson Json
  updatedAt DateTime @updatedAt
}

model NewsPost {
  id          String    @id @default(uuid())
  title       String
  bodyMd      String
  isPublished Boolean   @default(false)
  publishedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model ExclusiveDoc {
  id         String   @id @default(uuid())
  title      String
  blobPath   String
  mimeType   String
  isActive   Boolean  @default(true)
  uploadedAt DateTime @default(now())
}

model ExternalLink {
  id        String   @id @default(uuid())
  label     String
  url       String
  isActive  Boolean  @default(true)
  updatedAt DateTime @updatedAt
}

model ContentAttachment {
  id             String   @id @default(uuid())
  newsPostId     String?
  exclusiveDocId String?
  fileName       String
  blobPath       String
  mimeType       String
  sizeBytes      BigInt   @default(0)
  uploadedAt     DateTime @default(now())

  // NOTE: Prisma can't enforce XOR constraint directly; enforce in app validation.
}

model AuditLog {
  id          String    @id @default(uuid())
  actorType   ActorType
  actorUserId String?
  action      String
  entityType  String
  entityId    String?
  beforeJson  Json?
  afterJson   Json?
  ipAddress   String?
  sessionId   String?   @map("session_id") // Identity Framework: SID-A-* or SID-D-*
  createdAt   DateTime  @default(now())

  actorUser AppUser? @relation(fields: [actorUserId], references: [id])

  @@index([createdAt])
  @@index([entityType, entityId])
  @@index([actorUserId])
  @@index([sessionId])
}

model EmailLog {
  id             String   @id @default(uuid())
  recipientEmail String
  subject        String
  bodyText       String
  sentAt         DateTime @default(now())
  status         String // SENT, FAILED
  errorMessage   String?

  @@index([recipientEmail])
  @@index([sentAt])
}

model UploadTemplate {
  id           String   @id @default(uuid())
  templateName String   @unique
  fileName     String
  blobPath     String
  description  String?
  isActive     Boolean  @default(true)
  
  importType   String   // e.g., "PRODUCTS", "BACKORDERS"
  fileType     String   // "CSV", "XLSX"
  delimiter    String?  // For CSV
  hasHeader    Boolean  @default(true)
  
  mappingJson    Json?  // Field mappings
  validationJson Json?  // Validation rules

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([isActive])
}
